#!/bin/bash
# InternetFriends pre-commit hook

echo "ğŸ” Running pre-commit checks..."

# Check if we're on a protected branch
branch=$(git branch --show-current)
if [[ "$branch" == "main" || "$branch" == "develop" ]]; then
  echo "âŒ Direct commits to $branch are not allowed!"
  echo "ğŸ’¡ Use feature branches and pull requests."
  exit 1
fi

# Run linting if available
if command -v bun &> /dev/null && [ -f "package.json" ]; then
  echo "ğŸ§¹ Running linter..."
  bun run lint --fix 2>/dev/null || true
fi

# Validate diagrams
echo "ğŸ“‹ Validating mermaid diagrams..."
if bun run validate:diagrams 2>/dev/null; then
  echo "âœ… All diagrams have valid frontmatter"
else
  echo "âš ï¸  Some diagrams missing required tokens (non-blocking)"
fi

# Run component analysis for staged components
echo "ğŸ­ Analyzing staged components..."
staged_components=$(git diff --cached --name-only | grep -E "components/.*(atomic|molecular|organisms)/.*\.tsx$" | head -3)
if [ -n "$staged_components" ]; then
  echo "ğŸ“Š Components changed: $(echo $staged_components | tr '\n' ' ')"
  # Run quick component analysis (non-blocking but informative)
  if bun run analyze:components:summary --quiet 2>/dev/null | tail -5; then
    echo "ğŸ’¡ Consider improving component scores before commit"
  fi
else
  echo "ğŸ“ No component changes detected"
fi

# Run helper scoring tests if helper files changed
if git diff --cached --name-only | grep -E "helper|scoring" > /dev/null; then
  echo "ğŸ§ª Running helper scoring tests..."
  if ! bun run test:helper --reporter=minimal 2>/dev/null; then
    echo "âŒ Helper scoring tests failed"
    echo "ğŸ’¡ Fix test failures before committing"
    exit 1
  fi
  echo "âœ… Helper tests passed"
fi

# Check for secrets
echo "ğŸ” Checking for secrets..."
if git diff --cached --name-only | xargs grep -l "sk-\|pk_\|AKIA\|AIza" 2>/dev/null; then
  echo "âŒ Potential secrets detected in staged files!"
  echo "ğŸ’¡ Please remove API keys and secrets before committing."
  exit 1
fi

# Check for console.log and debugger statements in TypeScript files
echo "ğŸ› Checking for debugging statements..."
if git diff --cached --name-only | grep -E '\.(ts|tsx)$' | xargs grep -l "console\.log\|debugger" 2>/dev/null; then
  echo "âš ï¸  Debugging statements found in staged files"
  echo "ğŸ’¡ Consider removing console.log/debugger before commit"
  # Non-blocking - just a warning
fi

echo "âœ… Pre-commit checks passed"
